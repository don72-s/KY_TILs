# 애니메이션과 FSM

애니메이션을 표현할때에는 상태에 따라 전이하며 표현하는것이 정석적이고 안정적인 구조가 된다.

이는 상태패턴과 같은 구조이며 유한상태기계로 구성된다.

fsm이 뭔지 그리고 애니메이션을 어떻게 사용하는지 알아보자.

<br>

## 애니메이션으 동작

애니메이션을 돌리기 위해서는 여러가지 구성 요소가 필요하다.

<br>

### Animator

애니메이션을 돌리기 위해서는 animation controller가 필요하다.

해당 파일을 사용할 수 있게 해주는 컴포넌트가 animator 이다.

<br>

### Animator Controller

애니메이션 클립들을 등록하고, 여러가지 상태들을 등록하여 상태간의 전이 조건과 재생할 애니메이션을 규칙에따라 정의해 놓는 전체적인 애니메이션 재생 방식 설계도

<br>
### Animation Clip

실제로 재생할 애니메이션 파일.

컨트롤러에서 재생시킬 실질적인 애니메이션 파일이 된다.

<br>

### 정리

정리하자면 다음과 같다.

[animation clip]s => animation controller를 구성

animator 컴포넌트에서는 coltroller를 가져와서 애니메이션 구동 방식을 지정.

<br>

## 애니메이션 클립 제작

실제로 움직임이 정의된 파일은 애니메이션 클립이라고 했다.

보통은 전달받아서 사용하게 되겠지만, 기본적으로 작성하는 방법정도는 알아두도록 하자.

<br>

### 컨트롤러와 애니메이터 등록

우선 대상이 될 오브젝트에 애니메이터 컴포넌트를 붙여주고, 제작할 애니메이션 컨트롤러를 붙여준다.

이로써 해당 객체에 대하여 애니메이션을 관리하겠다는 사전 작업이 된것이다.

<br>

### 애니메이션 클립의 제작

애니메이션 클립을 하나 생성한 뒤, 대상이 될 컨트롤러 창을 켜준 뒤, 해당 창에 끌어다놓는다.

그렇다면 해당 애니메이션 클립은 연동된 컨트롤러를 가지고있는 오브젝트를 대상으로 하게 된다.

이때, 애니메이션 클립의 녹화버튼이 활성화되며 해당 버튼을 누른다면 오브젝트의 변화를 감지하게 된다.

이를 바탕으로 애니메이션 클립을 제작할 수 있다.

<br>

## 트랜지션과 상태변화

이렇게 애니메이션 클립들을 만들었다면, 이제 애니메이션간의 전환을 지정해 주어야 한다.

하지만 무작정 전환하는것은 아니고, 특정 조건이나 신호가 왔을때에 애니메이션을 전환해야 할 것이다.

예를들어 걷다가 점프키가 눌리면 올라가지는동안 상승 애니메이션, 떨어질때는 내려가는 애니메이션을 재생시켜야 할 것이다.

이를 어떻게 구현할 수 있을까?

<br> 

### 트랜지션

애니메이터 화면상에는 여러가지 애니메이션 클립들이 존재하는 상황일 것이다.

전환을 시작할 클립을 우클릭하여 트랜지션을 생성한 뒤, 전환 대상이 될 클립을 다시 선택하여 트랜지션을 지정해주면 된다.

<hr>

이렇게 트렌지션이 지정되었다면 해당 화살표 방향으로 애니메이션을 전환할 수 있다는 정의를 컨트롤러 상에 작성한 것이다.

<br>

### 파라미터

애니메이션을 트랜지션을 통하여 전환하기 위해서는 조건과 트리거등이 필요하다고 했다.

해당 역할을 하는 속성들을 파라미터라고 부른다.

`float, int, bool 자료형과 trigger` 4종류의 파라미터가 존재한다.

컨트롤러에서 파라미터들을 생성했다면, 해당 파라미터들의 상태를 기반으로 애니메이션을 전환할지를 결정하게 된다.

예를들어 int형 speed라는 변수가 있다면, 코드상에서 해당 변수를 건드릴 수 있게된다.

코드상으로 달리게 되어서 속도가 5 이상일때에는 걷는 애니메이션 상태에서 달리는 애니메이션으로 전환하고싶다! 라고 할 때에는

걷기 -> 달리기 사이의 트랜지션의 조건으로

`speed > 4` 와 같이 설정하면 될 것이다.

이렇게 된다면, walk상태에서 speed가 5 이상이 된다면 run상태로 전이하게 되는 애니메이션 설계도가 작성되게 된다.

<br>

#### Trigger

파라미터중에 trigger라는 타입도 있었다.
이건 뭘까?

상태를 전환할 때, 이벤트 형식으로 1회에 한해 이동시키고싶은 경우가 있다.

예를들어 a키가 눌렸을 때, 감정표현을 하고싶다 같은 느낌이 될 수 있다.

이럴때 다른 변수타입을 사용한다면, 전이가 완료된 뒤에는 원래값으로 돌려놓아야 한다는 단점이 있다.

한번 활성화된다면 또다시 해당 전이가 일어날 것이기 때문이다.

따라서 1회성인 전이 조건을 만들고 싶을 때 trigger 파라미터를 이용한다.

<br>

### 복수 트랜지션

하나의 트랜지션에서는 여러개의 파라미터를 조건으로써 사용할 수 있다.

다만, 하나의 트랜지션에 여러개의 조건이 있다면 반드시 and연산으로 취급되어버리기 때문에 or 동작을 하는 트랜지션을 만들길 바란다면

같은 방향의 트랜지션을 별도로 하나 더 작성할 필요가 있겠다.

<hr>

또는 갈라지는 분기점 트랜지션인데 전이조건이 완전히 똑같은 경우가 있다.

이럴때애는 해당 노드를 클릭해보면 등록된 트랜지션들이 나온다. 
해당 트랜지션들이 리스트형식으로 나타나는데, 위부터 확인하게 되므로 같은 조건에서의 전이 우선순위를 두고싶다면 해당 트랜지션을 위쪽으로 올려주면 되겠다.

<br>

## 코드에서의 파라미터 수정

조금 조잡하지만 애니메이션의 준비가 끝났다.
남은건 코드상에서 파라미터를 수정하는 것이다.

파라미터를 수정하게 된다면 나머지는 컨트롤러가 알아서 파라미터 값에 따라 전이하며 애니메이션을 재생시켜줄 것이다.

<hr>

캐릭터는 컨트롤러를 animator 컴포넌트에 가지고 있었다.
따라서 애니메이션을 제어하기 위해서는 animator컴포넌트를 가져올 필요가 있다.

이후에는 다음과 같은 코드를 작성하여 파라미터들을 조정할 수 있다.

```cs
Animator ani = GetComponent<Animator>();

ani.SetFloat("파라미터명", 0.2f);
ani.SetInt("파라미터명", 5);
ani.SetBool("파라미터명", false);
ani.SetTrigger("파라미터명");
```

<br>