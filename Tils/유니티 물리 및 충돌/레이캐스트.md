# 레이캐스트

충돌체간의 충돌을 감지하고 물리연산을 처리하는 방법을 알아봤다.

하지만 총알처럼 물체가 매우 빨라서 터널링 현상이 일어나서 충돌 감지를 못한다거나, 화면상에서 터치가 일어났을 때 터치 지점과 게임 씬 사이의 충돌체를 찾는다는 등의 1 : 1 충돌만으로는 모든 충돌 현상을 제어할 수 없다.

이러한 상황들을 고려하여 유니티에서는 **레이캐스트**라는 기능을 제공한다.

레이캐스트가 어떤 기능이고 어떻게 사용하는지 알아보도록 하자.

<br>

## 레이캐스트

레이캐스트는 이름에서도 유추할 수 있듯이 레이저를 쏘는 행위를 하며, 해당 레이저에 부딛힌 충돌체가 있는지 감지하는 역할을 한다.

이렇게 감지할 뿐만 아니라, 해당 충돌체에 대한 정보도 가져오므로 게임 개발에 없어서는 안될 기능중 하나로 이용되고 있다.

<br>

## 사용법

레이캐스트를 사용하기 위해서는 대부분에 상황에서 두가지의 변수가 필요하다.

- Ray : 레이저의 정보를 의미한다.
- RaycastHit: 충돌 대상의 정보를 반환하는데에 사용된다.

<br>

### Ray

ray타입 변수는 기본적으로 레이저를 **발사하는 위치**, 레이저를 **발사하는 방향** 두 가지를 필요로 한다.

코드상의 선언법은 다음과 같다.

`Ray ray = new Ray( 발사점, 발사 방향 );`

해당 Ray 변수를 이용하여 raycast를 진행할 수 있다.

<br>

## 레이캐스트의 진행

### Raycast

레이캐스트 함수의 원형은 다음과 같다.

```
public static bool Raycast(
    Ray ray, 
    out RaycastHit hitInfo,
    float maxDistance = Mathf.Infinity,
    int layerMask = DefaultRaycastLayers
);
```

반환값은 bool 형으로, 충돌체가 감지된 경우에는 true, 충돌체를 감지하지 못한 경우에는 false를 반환한다.

- 첫번째 매개변수는 사용할 Ray를 전달받는다.
미리 선언되어있지 않아도 시작점, 방향 두개의 벡터를 전달하는것으로 대체할 수 있다.

- 두번째 매개변수는 out 파라미터로 반환되는 목적의 매개변수로, 충돌이 일어난 충돌 정보를 전달해준다.( 충돌 법선벡터, 충돌점 등등...)

- 세번째 매개변수는 레이저를 쏠 거리이며, 기본값은 무한값으로 설정된다.

- 네번째 매개변수는 레이어 마크스에 대응하는 int 자료형으로, 검출할 레이어의 값들을 전달한다.

<hr>

##### LayerMask의 구조.
layerMask는 자료형은 정수이지만 조금 특별한 방식으로 layer를 구분, 저장한다.

int는 32비트로 표현되는 정수형 자료구조이며, 각 비트는 x번째 레이어를 의미한다.

즉, ......0000 0100 라는 십진수 4는 3번째 레이어를 의미한다.
또한 ...0000 0110 라는 십진수 6은 2번째와 3번째 레이어를 의미한다.

따라서 레이어의 번호는 1, 2, 3과 같이 정수의 진행이 아닌
각 비트의 활성화 여부로 해당 레이어의 체크를 확인한다.

<hr>

위의 레이어 마스크의 구조를 인지하여 int값을 넣어주면 활성화된 레이어 그룹에 있는 충돌체를 마주쳤을 때에만 true를 반환한다.

#### 단, 0을 전달한 경우에는 예외로써 모든 종류의 충돌체를 검출 대상에 넣는다.

+) 최신 유니티 버전에서는 LayerMask 변수를 인스펙터에서 설정할 수 있다.

<br>

### RaycastAll

raycast는 하나의 충돌체만 검출하게 된다.
그렇다면 하나의 ray로 여러개의 충돌체를 검출하기 위해서는 ray를 반복해서 쏴야 할까?

이러한 상황을 위해 RaycastAll 함수가 존재한다.

RaycastAll 함수의 원형은 다음과 같다.

```
public static RaycastHit[] RaycastAll (
    Ray ray, 
    float maxDistance= Mathf.Infinity, 
    int layerMask= DefaultRaycastLayers
);
```

낮선 키워드는 딱히 없다. 즉, 감지된 충돌들의 정보를 배열의 형태로 반환하게 된다.

단, 감지된 충돌이 없다면 null이 아닌 크기가 0인 배열을 반환하기 때문에, if에서 null체크가 아닌 배열의 크기를 확인해야 한다.

<br>