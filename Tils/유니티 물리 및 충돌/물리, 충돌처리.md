# 물리, 충돌처리

여러가지 기능을 만들기 위해서는 물리엔진의 도움이 필수다.
유니티에서 제공하는 물리엔진 관련 기능이 어떻게 이루어지고, 어떻게 사용할 수 있는지 알아보자.

<br>

## Rigidbody

물리현상에 관련된 기능을 이용하기 위해서는 rigidbody컴포넌트가 있어야 한다.

해당 함수가 있다면 중력, 물리회전, 공기저항 등의 설정과 적용이 가능해진다.

<br>

### 중력과 힘

rigidbody에 있는 속성들을 설정하여 중력의 영향등을 설정할 수 있으며, 함수들을 이용해 힘을 가할 수 있다.

- use gravity : 중력의 영향을 받는다.
- mass : 무게를 설정하며 힘에 의한 영향이 적어진다 ( 중력을 더 크게 받지는 않는다. )
- drag : 공기 저항을 받는 정도를 의미한다.
- is kinematic : 힘은 받지만 힘에 의한 이동등을 하지 않도록 설정한다.
<br>
- AddForce(vec3, mode) : 입력 벡터의 방향으로 벡터의 크기만큼 힘을 가한다.
- AddTorque(vec3, mode) : 입력 벡터를 축으로 하여 회전력을 준다.

mode에는 대표적으로 다음과 같은 옵션이 있다.
- force : 지속적으로 힘을 가한다.
- impulse : 일시적인 힘을 가한다.

<br>

## 태그

충돌을 위한 준비사항중에는 태그를 설정하는 과정이 있다.

모든 충돌체를 이름을 체크함으로써 분류하기보다는 태그를 달아 그룹화를 하여 분별하는 것이다.

크게 어려운 사항은 아니고, 오브젝트 좌상단에 태그를 설정해주면 된다.

<br>

## 충돌과 트리거

물리 처리를 이용하는 방식은 두가지 종류가 있다.

하나는 현실의 충돌 현상을 그대로 구현하는것, 또 하나는 충돌 여부만 판단하여 사용하는 것이다.

상황에 따라 두가지 기능을 사용해보자.

<br>

### 충돌체 ( collider )

충돌과 트리거 감지를 위해서는 각각의 고유 영역이 필요할 것이다.

이를 제공하는 것이 collider 컴포넌트다.

충돌체 컴포넌트를 추가하고 영역을 지정한다면 충돌 처리 준비가 된 것이다.

<br>
##### 복합 충돌체

모든 오브젝트를 하나의 충돌체로 표현할 수는 없을 것이다.
이럴 때에는 자식 오브젝트에 충돌체 컴포넌트를 여러개 추가한다면

부모 오브젝트는 하위 충돌체 컴포넌트를 모두 커버한다.

즉, 하위의 모든 충돌체 컴포넌트는 최상위 리지드바디 컴포넌트의 영향을 받게 설계된다.

<br>
### 충돌 ( collision )

충돌을 위해서는 당연한 조건이 필요하다.

- 둘 다 is kinematic이라면 서로 영향을 주지 않기로 약속한것이기 때문에 충돌이 일어나지 않는다.
- 두 충돌체 모두 rigidbody 컴포넌트가 존재해야 한다.
- 두 충돌체 모두 is trigger가 아니여야 한다.

<hr>

위의 조건이 만족된다면 다음과 같은 유니티 메세지 함수를 사용할 수 있다.

- OnCollisionEnter(collision _col) : 충돌체가 최초로 충돌했을 때 1회 호출.

- OnCollisionStay(collision _col) : 충돌체가 충돌하는 동안 지속적으로 호출.

- OnCollisionExit(collision _ col) : 충돌이 끝날 때 1회 호출.

각 함수는 상황에 따라 호출되며, 충돌된 충돌체의 정보를 매개변수로 전달받게 된다.

<br>

### 트리거 ( trigger )

충돌체간의 충돌 여부만이 필요하고, 물리적인 연산처리는 필요가 없을 경우, 또는 통과할 수 있는 특정 영역의 진입 등을 판별할 때에는 물리연산이나 튕겨내기등이 일어나서는 안된다.

이러한 상황을 위해 유니티 충돌체에는 trigger라는 옵션을 제공한다.

물론 대부분의 상황에서는 발동하지만 트리거 역시 조건이 존재한다.

- 상호작용 하는 충돌체는 반드시 충돌체 컴포넌트가 존재해야 한다.
- 또한 하나 이상의 충돌체에는 is trigger 항목이 활성화 되어 있어야 한다.
- 마지막으로 둘 중 하나 이상의 오브젝트에는 rigidbody 컴포넌트가 존재해야 한다.

<hr>

위의 조건이 만족된다면 다음과 같은 유니티 메세지 함수를 사용할 수 있다.

- OnTriggerEnter(collider _col) : 충돌체가 최초로 진입했을 때 1회 호출.

- OnTriggerStay(collider _col) : 충돌체가 진입 상태를 유지하는 동안 지속적으로 호출.

- OnTriggerExit(collider _ col) : 충돌체가 충돌 영역에서 나갈  때 1회 호출.

각 함수는 상황에 따라 호출되며, 충돌된 충돌체의 정보를 매개변수로 전달받게 된다.

<br>

## 레이어 ( Layer )

레이어는 사실 개념적으로 생각한다면 상술한 **태그**와 같은 개념이다. 하지만 태그는 조금 범용적인 인식표라고 볼 수 있고, 레이어는 `조금 더 물리 처리에 특화된` 그룹표 라고 할 수 있다. 

<br>

### 충돌 연산의 예외 처리

레이어의 가장 중요한 역할은 예외 그룹 설정이다.

즉, A 레이어는 B레이어와는 충돌하지 않는다.
또는, A 레이어는 A레이어와는 충돌하지 않는다.
등등의 설정을 해줄 수 있다.

설정창에서 설정할 수도 있지만 코드상으로도 다음과 같이
설정이 가능하다.

`Physics.IgnoreLayerCollision( 레이어1, 레이어2, [ true / false ]);`

첫번째와 두번째 매개변수로 전달된 레이어 그룹간의 충돌 여부를 설정할 수 있다.

세번째 매개변수로 true를 전달한다면 두 레이어 그룹은 서로 충돌처리가 일어나고, false를 전달한다면 두 레이어 그룹은 서로 충돌하지 않는다.

첫번째와 두번째 매개변수에 같은 레이어를 전달한다면 같은 레이어 그룹의 오브젝트간의 충돌 연산은 일어나지 않는다.

<br>

### 레이어를 통하지 않는 충돌 예외

충돌체가 레이어 그룹에 포함되어있지만, 예외적으로 충돌 처리를 무시하거나 충돌처리를 해야하는 예외그룹이 있을 수 있다.

이럴때에는 레이어를 또 분리한다기보다는 해당 충돌체만 예외 설정을 줄 수 있다.

단, 이러한 예외는 교차해서 적용은 안되고 레이어그룹간 / 충돌체간 설정만 가능하다.

즉, 같은 타입간의 설정만 가능하다.

충돌체간의 예외 설정은 다음과 같다.

`Physics.IgnoreCollision( 충돌체1, 충돌체2, [ true / false ]);`

매개변수들의 의미는 레이어 설정과 같다.

<br>